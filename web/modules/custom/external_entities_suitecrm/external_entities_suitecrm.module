<?php

/**
 * @file
 * Contains external_entities_suitecrm.module.
 */

use Drupal\Core\Form\FormStateInterface;
use Drupal\Core\Entity\EntityInterface;
use Drupal\Core\Entity\Display\EntityViewDisplayInterface;
use Drupal\Core\Render\Element;

/**
 * Implements hook_entity_view_alter().
 */
function external_entities_suitecrm_entity_view_alter(array &$build, EntityInterface $entity, EntityViewDisplayInterface $display) {
  // Only process external entities
  if (!$entity->getEntityTypeId() || strpos($entity->getEntityTypeId(), 'suitecrm_') !== 0) {
    return;
  }

  // Handle HTML rendering in text fields
  $field_definitions = $entity->getFieldDefinitions();

  foreach (Element::children($build) as $field_name) {
    if (!isset($field_definitions[$field_name]) || !isset($build[$field_name])) {
      continue;
    }

    $field_definition = $field_definitions[$field_name];
    $field_type = $field_definition->getType();

    if (in_array($field_type, ['string', 'string_long', 'text', 'text_long'])) {
      foreach (Element::children($build[$field_name]) as $delta) {
        if ($entity->hasField($field_name)) {
          $field_item = $entity->get($field_name)->get($delta);
          if ($field_item) {
            $value = $field_item->value;
            if ($value && is_string($value) && strip_tags($value) !== $value) {
              $build[$field_name][$delta] = [
                '#markup' => $value,
                '#cache' => $build[$field_name][$delta]['#cache'] ?? [],
              ];
            }
          }
        }
      }
    }
  }
}

/**
 * Implements hook_entity_update().
 */
function external_entities_suitecrm_entity_update(EntityInterface $entity) {
  if ($entity->getEntityTypeId() !== 'external_entity_type') {
    return;
  }

  $entity_id = $entity->id();
  if (!$entity_id || strpos($entity_id, 'suitecrm_') !== 0) {
    return;
  }

  // Get storage config from POST data
  $request = \Drupal::request();
  $post_data = $request->request->all();

  if (isset($post_data['storages_tab']['config']['storage_clients'][0]['config'])) {
    $storage_config = $post_data['storages_tab']['config']['storage_clients'][0]['config'];

    $data_aggregator = $entity->get('data_aggregator');
    if (!empty($data_aggregator)) {
      $data_aggregator['config']['storage_clients'][0]['config'] = $storage_config;
      $entity->set('data_aggregator', $data_aggregator);

      if (!isset($entity->isUpdatingFromHook)) {
        $entity->isUpdatingFromHook = TRUE;
        $entity->save();
      }
    }
  }

  // Get links from POST
  $config = \Drupal::configFactory()->getEditable('external_entities.external_entity_type.' . $entity_id);

  if (isset($post_data['links'])) {
    $links = $post_data['links'];
    unset($links['help']);
    $links = array_filter($links, function($value) {
      return !empty($value);
    });

    if (!empty($links)) {
      $config->set('links', $links);
    }
  }

  // Set persistent
  $config->set('persistent', TRUE);
  $config->save();

  \Drupal::service('router.builder')->rebuild();
  \Drupal::entityTypeManager()->clearCachedDefinitions();
}

/**
 * Implements hook_entity_presave().
 */
function external_entities_suitecrm_entity_presave(EntityInterface $entity) {
  if ($entity->getEntityTypeId() !== 'external_entity_type') {
    return;
  }

  if ($entity->id() !== 'suitecrm_case') {
    return;
  }

  $data_aggregator = $entity->get('data_aggregator');

  if (isset($data_aggregator['config']['storage_clients'][0]['config']) &&
    empty($data_aggregator['config']['storage_clients'][0]['config'])) {

    $current_entity = \Drupal::entityTypeManager()
      ->getStorage('external_entity_type')
      ->loadUnchanged('suitecrm_case');

    if ($current_entity) {
      $current_data_aggregator = $current_entity->get('data_aggregator');

      if (!empty($current_data_aggregator['config']['storage_clients'][0]['config'])) {
        $data_aggregator['config']['storage_clients'][0]['config'] =
          $current_data_aggregator['config']['storage_clients'][0]['config'];

        $entity->set('data_aggregator', $data_aggregator);
      }
    }
  }
}

/**
 * Implements hook_form_FORM_ID_alter() for external_entity_type_edit_form.
 */
function external_entities_suitecrm_form_external_entity_type_edit_form_alter(&$form, FormStateInterface $form_state, $form_id) {
  $entity = $form_state->getFormObject()->getEntity();

  // Only add links UI for suitecrm entities
  if (strpos($entity->id(), 'suitecrm_') !== 0) {
    return;
  }

  // Get current links
  $config = \Drupal::config('external_entities.external_entity_type.' . $entity->id());
  $current_links = $config->get('links') ?: [];

  // Add links configuration section
  $form['links'] = [
    '#type' => 'details',
    '#title' => t('Entity Links'),
    '#description' => t('Configure URL paths for entity operations. Use {' . $entity->id() . '} as a placeholder for the entity ID.'),
    '#open' => FALSE,
    '#tree' => TRUE,
    '#weight' => 10,
  ];

  $form['links']['help'] = [
    '#markup' => '<p>' . t('Example: <code>/case/{suitecrm_case}</code> for viewing a case, <code>/case/add</code> for creating a new case.') . '</p>',
  ];

  $link_types = [
    'canonical' => t('View (canonical)'),
    'edit-form' => t('Edit form'),
    'add-form' => t('Add form'),
    'delete-form' => t('Delete form'),
    'collection' => t('Collection/List'),
  ];

  foreach ($link_types as $key => $label) {
    $form['links'][$key] = [
      '#type' => 'textfield',
      '#title' => $label,
      '#default_value' => $current_links[$key] ?? '',
      '#placeholder' => $key === 'add-form' ? '/case/add' : '/case/{suitecrm_case}',
    ];
  }
}
