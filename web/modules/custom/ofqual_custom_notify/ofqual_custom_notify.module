<?php

use Drupal\user\UserInterface;

/**
 * Implements hook_user_login().
 *
 * Sends a notification when a user logs in.
 *
 * @param \Drupal\user\UserInterface $account
 *   The user account that logged in.
 */
function ofqual_custom_notify_user_login(UserInterface $account) {
  $accountName = $account->getAccountName();
  $targetUpn = $account->getEmail();

  if (empty($targetUpn)) {
    \Drupal::logger('ofqual_custom_notify')->error('User email is missing for @username', ['@username' => $accountName]);
    return;
  }

  \Drupal::messenger()->addMessage(t('Welcome back, @username!', ['@username' => $accountName]));
  \Drupal::logger('ofqual_custom_notify')->notice('User @username has logged in.', ['@username' => $accountName]);

  // Required environment variables
  $requiredEnvVars = [
    'NOTIFICATION_SOURCE_ID',
    'NOTIFICATION_SOURCE_UPN',
  ];

  $apiCredentials = [];

  foreach ($requiredEnvVars as $envVar) {
    $value = getenv($envVar);
    if (empty($value)) {
      \Drupal::logger('ofqual_custom_notify')->error('Missing environment variable: @var', ['@var' => $envVar]);
      return;
    }
    $apiCredentials[strtolower($envVar)] = $value;
  }

  // Prepare notification payload
  $notificationPayload = [
    'SourceId'      => $apiCredentials['notification_source_id'],
    'SourceModule'  => 1,
    'SourceUpn'     => $apiCredentials['notification_source_upn'],
    'Summary'       => "$accountName successfully signed in via Single Sign-On",
    'TargetUpn'     => $targetUpn,
  ];

  // Send notification using the service
  $notificationService = \Drupal::service('ofqual_custom_notify.notification_service');
  $notificationService->send($notificationPayload);
}