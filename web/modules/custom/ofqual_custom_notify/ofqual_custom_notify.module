<?php

use Drupal\user\UserInterface;
use Drupal\key\Entity\Key;

/**
 * Implements hook_user_login().
 *
 * Sends a notification when a user logs in.
 *
 * @param \Drupal\user\UserInterface $account
 *   The user account that logged in.
 */
function ofqual_custom_notify_user_login(UserInterface $account) {
  $accountName = $account->getAccountName();
  $targetUpn = $account->getEmail();

  if (empty($targetUpn)) {
    \Drupal::logger('ofqual_custom_notify')->error('User email is missing for @username', ['@username' => $accountName]);
    return;
  }

  \Drupal::messenger()->addMessage(t('Welcome back, @username!', ['@username' => $accountName]));
  \Drupal::logger('ofqual_custom_notify')->notice('User @username has logged in.', ['@username' => $accountName]);

  $requiredKeys = [
    'source_id' => 'source_id',
    'source_upn' => 'source_upn'
  ];

  $apiCredentials = [];
  $keyRepository = \Drupal::service('key.repository');

  foreach ($requiredKeys as $property => $keyId) {
    $keyEntity = $keyRepository->getKey($keyId);
    if (!$keyEntity || empty($keyEntity->getKeyValue())) {
      \Drupal::logger('ofqual_custom_notify')->error('Missing key: @key', ['@key' => $keyId]);
      return;
    }
    $apiCredentials[$property] = $keyEntity->getKeyValue();
  }

  $notificationPayload = [
      'SourceId'      => $apiCredentials['source_id'],
      'SourceModule'  => 1,
      'SourceUpn'     => $apiCredentials['source_upn'],
      'Summary'       => "$accountName successfully signed in via Single Sign-On",
      'TargetUpn'     => $targetUpn,
  ];

  $notificationService = \Drupal::service('ofqual_custom_notify.notification_service');
  $notificationService->send($notificationPayload);
}