<?php

/**
 * @file
 * Contains openid_role_mapping.module.
 */

use Drupal\user\Entity\Role;
use Drupal\user\UserInterface;

/**
 * Implements hook_openid_connect_userinfo_save().
 *
 * Applies role mappings after userinfo is saved to the user entity.
 */
function openid_role_mapping_openid_connect_userinfo_save(UserInterface $account, array $userinfo): void {
  $config = \Drupal::config('openid_connect.settings');
  $role_mappings = $config->get('role_mappings') ?: [];
  $role_claim_key = $config->get('role_claim') ?: 'roles';

  $external_roles = $userinfo['userinfo'][$role_claim_key] ?? [];

  if (empty($external_roles) && isset($userinfo['user_data'][$role_claim_key])) {
    $external_roles = $userinfo['user_data'][$role_claim_key];
  }

  if (!is_array($external_roles)) {
    $external_roles = preg_split('/[\s,]+/', trim((string) $external_roles), -1, PREG_SPLIT_NO_EMPTY);
  }

  if (empty($external_roles)) {
    return;
  }

  $roles_added = [];

  foreach ($role_mappings as $drupal_role_id => $mapped_external_roles) {
    $mapped_external_roles = is_array($mapped_external_roles) ? $mapped_external_roles : [$mapped_external_roles];

    if (array_intersect($mapped_external_roles, $external_roles)) {
      if (Role::load($drupal_role_id) && !in_array($drupal_role_id, $account->getRoles(), TRUE)) {
        $account->addRole($drupal_role_id);
        $roles_added[] = $drupal_role_id;
      }
    }
  }

  if (!empty($roles_added)) {
    $account->save();
  }
}
